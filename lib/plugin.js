var LogSchema, PluginFn, Schema, _, mongoose;

_ = require('lodash');

mongoose = require('mongoose');

Schema = mongoose.Schema;

LogSchema = new Schema({
  timestamp: {
    required: true,
    type: Date
  },
  log: {
    required: true,
    type: Schema.Types.Mixed
  }
});

PluginFn = function(schema, arg) {
  var ref, ref1, taskFn, timeout;
  ref = arg != null ? arg : {}, taskFn = ref.taskFn, timeout = (ref1 = ref.timeout) != null ? ref1 : null;
  if (taskFn == null) {
    throw new Error("'taskFn' parameter must be provided to MongoQueuer.TaskPlugin constructor");
  }
  schema.statics._mongoQueuerOptions = {
    taskFn: taskFn,
    timeout: timeout
  };
  schema.add({
    status: {
      required: true,
      type: String,
      "enum": ['QUEUED', 'EXECUTING', 'FAILED', 'SUCCESS']
    },
    substatus: {
      required: false,
      "default": null,
      type: String,
      "enum": ['FAILED_ERR', 'FAILED_TIMEOUT', null]
    },
    error: {
      required: false,
      "default": null,
      type: Schema.Types.Mixed
    },
    result: {
      required: false,
      "default": null,
      type: Schema.Types.Mixed
    },
    status_change_at: {
      required: true,
      type: Date
    },
    timeout_at: {
      required: false,
      "default": null,
      type: Date
    },
    status_history: {
      "default": [],
      type: [Schema.Types.Mixed]
    },
    logs: {
      "default": [],
      type: [LogSchema]
    }
  });
  schema.statics._updateStatusKwargs = function(status, substatus, arg1) {
    var commonKwargs, isInsert, kwargs, ref2, ref3, ref4, updateKwargs;
    ref2 = arg1 != null ? arg1 : {}, updateKwargs = (ref3 = ref2.updateKwargs) != null ? ref3 : {}, isInsert = (ref4 = ref2.isInsert) != null ? ref4 : false;
    commonKwargs = _.assign({
      status: status,
      substatus: substatus,
      status_change_at: new Date()
    }, updateKwargs);
    kwargs = _.clone(commonKwargs);
    if (isInsert) {
      kwargs['status_history'] = commonKwargs;
    } else {
      kwargs['$push'] = {
        status_history: commonKwargs
      };
    }
    return kwargs;
  };
  schema.statics.createTask = function(taskKwargs, done) {
    var defaultKwargs, kwargs, task;
    defaultKwargs = this._updateStatusKwargs('QUEUED', null, {
      isInsert: true
    });
    kwargs = _.chain(taskKwargs).omit(function(k) {
      return k === "status" || k === "substatus" || k === "error" || k === "result" || k === "status_change_at" || k === "timeout_at" || k === "status_history" || k === "logs";
    }).defaults(defaultKwargs).value();
    task = new this(kwargs);
    return task.save(function(err, task, numAffected) {
      return done(err, task);
    });
  };
  schema.methods.addLog = function(logKwargs) {
    var Model, kwargs, opts, query, subDocKwargs;
    Model = this.constructor;
    query = {
      _id: this._id
    };
    opts = {
      upsert: true
    };
    subDocKwargs = {
      timestamp: new Date(),
      log: logKwargs
    };
    kwargs = {
      $push: {
        logs: subDocKwargs
      }
    };
    return Model.update(query, kwargs, opts).exec();
  };
  schema.methods.retry = function(done) {
    var Model, ref2;
    Model = this.constructor;
    if ((ref2 = this.status) !== 'FAILED' && ref2 !== 'SUCCESS') {
      return done(new Error("Improper status for retry: <" + this.status + ">"));
    }
    return this._updateStatus('QUEUED', null, null, done);
  };
  schema.methods._updateStatus = function(status, substatus, resultObject, done) {
    var Model, kwargs, opts, query, ref2, ref3, ref4, ref5, ref6, ref7;
    if (resultObject == null) {
      resultObject = {};
    }
    Model = this.constructor;
    query = {
      _id: this._id,
      status_change_at: this.status_change_at
    };
    kwargs = Model._updateStatusKwargs(status, substatus, {
      updateKwargs: {
        result: (ref2 = (ref3 = (ref4 = resultObject.result) != null ? typeof ref4.toJSON === "function" ? ref4.toJSON() : void 0 : void 0) != null ? ref3 : resultObject != null ? resultObject.result : void 0) != null ? ref2 : null,
        error: (ref5 = (ref6 = (ref7 = resultObject.error) != null ? typeof ref7.toJSON === "function" ? ref7.toJSON() : void 0 : void 0) != null ? ref6 : resultObject != null ? resultObject.error : void 0) != null ? ref5 : null
      }
    });
    opts = {
      "new": true
    };
    return Model.findOneAndUpdate(query, kwargs, opts, function(err, updatedObject) {
      if (err != null) {
        return done(err);
      }
      if (updatedObject == null) {
        return done(new Error("Task no longer owned by caller."));
      }
      return done(null, updatedObject);
    });
  };
  schema.statics._dequeueOne = function(done) {
    var kwargs, opts, query, updateKwargs;
    query = {
      status: 'QUEUED'
    };
    updateKwargs = {};
    if (timeout) {
      updateKwargs.timeout_at = new Date(Date.now() + timeout);
    }
    kwargs = this._updateStatusKwargs('EXECUTING', null, {
      updateKwargs: updateKwargs
    });
    opts = {
      "new": true
    };
    return this.findOneAndUpdate(query, kwargs, opts, done);
  };
  return schema.statics._failTimedOutOne = function(done) {
    var kwargs, opts, query;
    query = {
      status: 'EXECUTING',
      timeout_at: {
        $lt: new Date()
      }
    };
    kwargs = this._updateStatusKwargs('FAILED', 'FAILED_TIMEOUT');
    opts = {
      "new": true
    };
    return this.findOneAndUpdate(query, kwargs, opts, done);
  };
};

module.exports = PluginFn;

//# sourceMappingURL=data:application/json;base64,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cmNlc0NvbnRlbnQiOlsiXyAgICAgICAgICA9IHJlcXVpcmUgJ2xvZGFzaCdcblxubW9uZ29vc2UgICA9IHJlcXVpcmUgJ21vbmdvb3NlJ1xuU2NoZW1hICAgICA9IG1vbmdvb3NlLlNjaGVtYVxuXG4jIFNjaGVtYXNcbiMgQFRPRE86IFBvbGxpbmdcblxuTG9nU2NoZW1hID0gbmV3IFNjaGVtYSB7XG4gIHRpbWVzdGFtcDpcbiAgICByZXF1aXJlZDogdHJ1ZVxuICAgIHR5cGU6ICAgICBEYXRlXG4gIGxvZzpcbiAgICByZXF1aXJlZDogdHJ1ZVxuICAgIHR5cGU6ICAgICBTY2hlbWEuVHlwZXMuTWl4ZWRcbn1cblxuIyBQbHVnaW5cblBsdWdpbkZuID0gKHNjaGVtYSwgeyB0YXNrRm4sIHRpbWVvdXQgPSBudWxsIH0gPSB7fSkgLT5cbiAgdGhyb3cgbmV3IEVycm9yKFwiJ3Rhc2tGbicgcGFyYW1ldGVyIG11c3QgYmUgcHJvdmlkZWQgdG8gTW9uZ29RdWV1ZXIuVGFza1BsdWdpbiBjb25zdHJ1Y3RvclwiKSB1bmxlc3MgdGFza0ZuP1xuXG4gIHNjaGVtYS5zdGF0aWNzLl9tb25nb1F1ZXVlck9wdGlvbnMgPVxuICAgIHRhc2tGbjogIHRhc2tGblxuICAgIHRpbWVvdXQ6IHRpbWVvdXRcblxuICBzY2hlbWEuYWRkXG4gICAgc3RhdHVzOlxuICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICAgIHR5cGU6ICAgICBTdHJpbmdcbiAgICAgIGVudW06ICAgICBbICdRVUVVRUQnLCAnRVhFQ1VUSU5HJywgJ0ZBSUxFRCcsICdTVUNDRVNTJyBdXG4gICAgc3Vic3RhdHVzOlxuICAgICAgcmVxdWlyZWQ6IGZhbHNlXG4gICAgICBkZWZhdWx0OiAgbnVsbFxuICAgICAgdHlwZTogICAgIFN0cmluZ1xuICAgICAgZW51bTogICAgIFsgJ0ZBSUxFRF9FUlInLCAnRkFJTEVEX1RJTUVPVVQnLCBudWxsIF1cbiAgICBlcnJvcjpcbiAgICAgIHJlcXVpcmVkOiBmYWxzZVxuICAgICAgZGVmYXVsdDogIG51bGxcbiAgICAgIHR5cGU6ICAgICBTY2hlbWEuVHlwZXMuTWl4ZWRcbiAgICByZXN1bHQ6XG4gICAgICByZXF1aXJlZDogZmFsc2VcbiAgICAgIGRlZmF1bHQ6ICBudWxsXG4gICAgICB0eXBlOiAgICAgU2NoZW1hLlR5cGVzLk1peGVkXG4gICAgc3RhdHVzX2NoYW5nZV9hdDpcbiAgICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgICB0eXBlOiAgICAgRGF0ZVxuICAgIHRpbWVvdXRfYXQ6XG4gICAgICByZXF1aXJlZDogZmFsc2VcbiAgICAgIGRlZmF1bHQ6ICBudWxsXG4gICAgICB0eXBlOiAgICAgRGF0ZVxuICAgIHN0YXR1c19oaXN0b3J5OlxuICAgICAgZGVmYXVsdDogIFtdXG4gICAgICB0eXBlOiAgICAgWyBTY2hlbWEuVHlwZXMuTWl4ZWQgXVxuICAgIGxvZ3M6XG4gICAgICBkZWZhdWx0OiAgW11cbiAgICAgIHR5cGU6ICAgICBbIExvZ1NjaGVtYSBdXG5cbiAgIyBIZWxwZXJzXG4gIHNjaGVtYS5zdGF0aWNzLl91cGRhdGVTdGF0dXNLd2FyZ3MgPSAoc3RhdHVzLCBzdWJzdGF0dXMsIHsgdXBkYXRlS3dhcmdzPXt9LCBpc0luc2VydD1mYWxzZSB9ID0ge30pIC0+XG4gICAgY29tbW9uS3dhcmdzID0gXy5hc3NpZ24ge1xuICAgICAgc3RhdHVzOiAgICAgICAgICAgc3RhdHVzXG4gICAgICBzdWJzdGF0dXM6ICAgICAgICBzdWJzdGF0dXNcbiAgICAgIHN0YXR1c19jaGFuZ2VfYXQ6IG5ldyBEYXRlKClcbiAgICB9LCB1cGRhdGVLd2FyZ3NcblxuICAgIGt3YXJncyA9IF8uY2xvbmUgY29tbW9uS3dhcmdzXG5cbiAgICBpZiBpc0luc2VydFxuICAgICAga3dhcmdzWydzdGF0dXNfaGlzdG9yeSddID0gY29tbW9uS3dhcmdzXG4gICAgZWxzZVxuICAgICAga3dhcmdzWyckcHVzaCddID0geyBzdGF0dXNfaGlzdG9yeTogY29tbW9uS3dhcmdzIH1cblxuICAgIHJldHVybiBrd2FyZ3NcblxuICAjIENyZWF0ZVxuICBzY2hlbWEuc3RhdGljcy5jcmVhdGVUYXNrID0gKHRhc2tLd2FyZ3MsIGRvbmUpIC0+XG4gICAgZGVmYXVsdEt3YXJncyA9IEBfdXBkYXRlU3RhdHVzS3dhcmdzICdRVUVVRUQnLCBudWxsLCBpc0luc2VydDogdHJ1ZVxuXG4gICAga3dhcmdzID1cbiAgICAgIF8uY2hhaW4gdGFza0t3YXJnc1xuICAgICAgICAub21pdCAoaykgLT4gayBpbiBbXCJzdGF0dXNcIiwgXCJzdWJzdGF0dXNcIiwgXCJlcnJvclwiLCBcInJlc3VsdFwiLCBcInN0YXR1c19jaGFuZ2VfYXRcIiwgXCJ0aW1lb3V0X2F0XCIsIFwic3RhdHVzX2hpc3RvcnlcIiwgXCJsb2dzXCJdXG4gICAgICAgIC5kZWZhdWx0cyBkZWZhdWx0S3dhcmdzXG4gICAgICAgIC52YWx1ZSgpXG5cbiAgICB0YXNrID0gbmV3IEAoa3dhcmdzKVxuICAgIHRhc2suc2F2ZSAoZXJyLCB0YXNrLCBudW1BZmZlY3RlZCkgLT5cbiAgICAgIGRvbmUgZXJyLCB0YXNrXG5cbiAgIyBMb2dnaW5nXG4gIHNjaGVtYS5tZXRob2RzLmFkZExvZyA9IChsb2dLd2FyZ3MpIC0+XG4gICAgTW9kZWwgPSBAY29uc3RydWN0b3JcblxuICAgIHF1ZXJ5ICAgICAgICA9IHsgX2lkOiBAX2lkIH1cbiAgICBvcHRzICAgICAgICAgPSB7IHVwc2VydDogdHJ1ZSB9XG5cbiAgICBzdWJEb2NLd2FyZ3MgPVxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpXG4gICAgICBsb2c6ICAgICAgIGxvZ0t3YXJnc1xuXG4gICAga3dhcmdzICAgICAgID0geyAkcHVzaDogeyBsb2dzOiBzdWJEb2NLd2FyZ3MgfSB9XG5cbiAgICAjIExvZyBpcyBub3QgY29uc2lkZXJlZCB0byBiZSBtaXNzaW9uLWNyaXRpY2FsLCBubyBjYWxsYmFjay5cbiAgICBNb2RlbC51cGRhdGUocXVlcnksIGt3YXJncywgb3B0cykuZXhlYygpXG5cbiAgc2NoZW1hLm1ldGhvZHMucmV0cnkgPSAoZG9uZSkgLT5cbiAgICBNb2RlbCA9IEBjb25zdHJ1Y3RvclxuXG4gICAgdW5sZXNzIEBzdGF0dXMgaW4gWyAnRkFJTEVEJywgJ1NVQ0NFU1MnIF1cbiAgICAgIHJldHVybiBkb25lIG5ldyBFcnJvcihcIkltcHJvcGVyIHN0YXR1cyBmb3IgcmV0cnk6IDwje0BzdGF0dXN9PlwiKVxuXG4gICAgQF91cGRhdGVTdGF0dXMgJ1FVRVVFRCcsIG51bGwsIG51bGwsIGRvbmVcblxuICAjIFVwZGF0ZVxuICBzY2hlbWEubWV0aG9kcy5fdXBkYXRlU3RhdHVzID0gKHN0YXR1cywgc3Vic3RhdHVzLCByZXN1bHRPYmplY3Q9e30sIGRvbmUpIC0+XG4gICAgTW9kZWwgPSBAY29uc3RydWN0b3JcblxuICAgIHF1ZXJ5ID0geyBfaWQ6IEBfaWQsIHN0YXR1c19jaGFuZ2VfYXQ6IEBzdGF0dXNfY2hhbmdlX2F0IH1cblxuICAgIGt3YXJncyA9IE1vZGVsLl91cGRhdGVTdGF0dXNLd2FyZ3Mgc3RhdHVzLCBzdWJzdGF0dXMsIHtcbiAgICAgIHVwZGF0ZUt3YXJnczpcbiAgICAgICAgcmVzdWx0OiByZXN1bHRPYmplY3QucmVzdWx0Py50b0pTT04/KCkgPyByZXN1bHRPYmplY3Q/LnJlc3VsdCA/IG51bGxcbiAgICAgICAgZXJyb3I6ICByZXN1bHRPYmplY3QuZXJyb3I/LnRvSlNPTj8oKSA/IHJlc3VsdE9iamVjdD8uZXJyb3IgPyBudWxsXG4gICAgfVxuXG4gICAgb3B0cyAgPSB7IG5ldzogdHJ1ZSB9XG5cbiAgICBNb2RlbC5maW5kT25lQW5kVXBkYXRlIHF1ZXJ5LCBrd2FyZ3MsIG9wdHMsIChlcnIsIHVwZGF0ZWRPYmplY3QpIC0+XG4gICAgICByZXR1cm4gZG9uZSBlcnIgaWYgZXJyP1xuICAgICAgcmV0dXJuIGRvbmUgbmV3IEVycm9yKFwiVGFzayBubyBsb25nZXIgb3duZWQgYnkgY2FsbGVyLlwiKSB1bmxlc3MgdXBkYXRlZE9iamVjdD9cblxuICAgICAgZG9uZSBudWxsLCB1cGRhdGVkT2JqZWN0XG5cbiAgIyBGZXRjaFxuICBzY2hlbWEuc3RhdGljcy5fZGVxdWV1ZU9uZSA9IChkb25lKSAtPlxuICAgIHF1ZXJ5ICA9IHsgc3RhdHVzOiAnUVVFVUVEJyB9XG5cbiAgICB1cGRhdGVLd2FyZ3MgPSB7fVxuICAgIGlmIHRpbWVvdXRcbiAgICAgIHVwZGF0ZUt3YXJncy50aW1lb3V0X2F0ID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIHRpbWVvdXQpXG5cbiAgICBrd2FyZ3MgPSBAX3VwZGF0ZVN0YXR1c0t3YXJncyAnRVhFQ1VUSU5HJywgbnVsbCwgeyB1cGRhdGVLd2FyZ3M6IHVwZGF0ZUt3YXJncyB9XG5cbiAgICAjIENhbid0IHVzZSBtdWx0aSwgYmVjYXVzZSBpdCdzIG5vdCBhdG9taWMuXG4gICAgb3B0cyAgID0geyBuZXc6IHRydWUgfVxuXG4gICAgQGZpbmRPbmVBbmRVcGRhdGUgcXVlcnksIGt3YXJncywgb3B0cywgZG9uZVxuXG4gIHNjaGVtYS5zdGF0aWNzLl9mYWlsVGltZWRPdXRPbmUgPSAoZG9uZSkgLT5cbiAgICBxdWVyeSAgPSB7IHN0YXR1czogJ0VYRUNVVElORycsIHRpbWVvdXRfYXQ6IHsgJGx0OiBuZXcgRGF0ZSgpIH0gfVxuICAgIGt3YXJncyA9IEBfdXBkYXRlU3RhdHVzS3dhcmdzICdGQUlMRUQnLCAnRkFJTEVEX1RJTUVPVVQnXG5cbiAgICAjIENhbid0IHVzZSBtdWx0aSwgYmVjYXVzZSBpdCdzIG5vdCBhdG9taWMuXG4gICAgb3B0cyAgID0geyBuZXc6IHRydWUgfVxuXG4gICAgQGZpbmRPbmVBbmRVcGRhdGUgcXVlcnksIGt3YXJncywgb3B0cywgZG9uZVxuXG5cbm1vZHVsZS5leHBvcnRzID0gUGx1Z2luRm5cbiJdfQ==
