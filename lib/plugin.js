var LogSchema, PluginFn, Schema, _, mongoose;

_ = require('lodash');

mongoose = require('mongoose');

Schema = mongoose.Schema;

LogSchema = new Schema({
  timestamp: {
    required: true,
    type: Date
  },
  log: {
    required: true,
    type: Schema.Types.Mixed
  }
});

PluginFn = function(schema, arg) {
  var ref, ref1, taskFn, timeout;
  ref = arg != null ? arg : {}, taskFn = ref.taskFn, timeout = (ref1 = ref.timeout) != null ? ref1 : null;
  if (taskFn == null) {
    throw new Error("'taskFn' parameter must be provided to MongoQueuer.TaskPlugin constructor");
  }
  schema.statics._mongoQueuerOptions = {
    taskFn: taskFn,
    timeout: timeout
  };
  schema.add({
    status: {
      required: true,
      type: String,
      "enum": ['QUEUED', 'EXECUTING', 'FAILED', 'SUCCESS']
    },
    substatus: {
      required: false,
      "default": null,
      type: String,
      "enum": ['FAILED_ERR', 'FAILED_TIMEOUT', null]
    },
    error: {
      required: false,
      "default": null,
      type: Schema.Types.Mixed
    },
    result: {
      required: false,
      "default": null,
      type: Schema.Types.Mixed
    },
    status_change_at: {
      required: true,
      type: Date
    },
    timeout_at: {
      required: false,
      "default": null,
      type: Date
    },
    status_history: {
      "default": [],
      type: [Schema.Types.Mixed]
    },
    logs: {
      "default": [],
      type: [LogSchema]
    }
  });
  schema.statics._updateStatusKwargs = function(status, substatus, arg1) {
    var commonKwargs, isInsert, kwargs, ref2, ref3, ref4, updateKwargs;
    ref2 = arg1 != null ? arg1 : {}, updateKwargs = (ref3 = ref2.updateKwargs) != null ? ref3 : {}, isInsert = (ref4 = ref2.isInsert) != null ? ref4 : false;
    commonKwargs = _.assign({
      status: status,
      substatus: substatus,
      status_change_at: new Date()
    }, updateKwargs);
    kwargs = _.clone(commonKwargs);
    if (isInsert) {
      kwargs['status_history'] = commonKwargs;
    } else {
      kwargs['$push'] = {
        status_history: commonKwargs
      };
    }
    return kwargs;
  };
  schema.statics.createTask = function(taskKwargs, done) {
    var defaultKwargs, kwargs, task;
    defaultKwargs = this._updateStatusKwargs('QUEUED', null, {
      isInsert: true
    });
    kwargs = _.chain(taskKwargs).omit(function(k) {
      return k === "status" || k === "substatus" || k === "error" || k === "result" || k === "status_change_at" || k === "timeout_at" || k === "status_history" || k === "logs";
    }).defaults(defaultKwargs).value();
    task = new this(kwargs);
    return task.save(function(err, task, numAffected) {
      return done(err, task);
    });
  };
  schema.methods.addLog = function(logKwargs) {
    var Model, kwargs, opts, query, subDocKwargs;
    Model = this.constructor;
    query = {
      _id: this._id
    };
    opts = {
      upsert: true
    };
    subDocKwargs = {
      timestamp: new Date(),
      log: logKwargs
    };
    kwargs = {
      $push: {
        logs: subDocKwargs
      }
    };
    return Model.update(query, kwargs, opts).exec();
  };
  schema.methods.retry = function(done) {
    var Model, ref2;
    Model = this.constructor;
    if ((ref2 = this.status) !== 'FAILED' && ref2 !== 'SUCCESS') {
      return done(new Error("Improper status for retry: <" + this.status + ">"));
    }
    return this._updateStatus('QUEUED', null, null, done);
  };
  schema.methods._updateStatus = function(status, substatus, resultObject, done) {
    var Model, kwargs, opts, query, ref2, ref3, ref4, ref5, ref6, ref7;
    if (resultObject == null) {
      resultObject = {};
    }
    Model = this.constructor;
    query = {
      _id: this._id,
      status_change_at: this.status_change_at
    };
    kwargs = Model._updateStatusKwargs(status, substatus, {
      updateKwargs: {
        result: (ref2 = (ref3 = (ref4 = resultObject.result) != null ? typeof ref4.toJSON === "function" ? ref4.toJSON() : void 0 : void 0) != null ? ref3 : resultObject != null ? resultObject.result : void 0) != null ? ref2 : null,
        error: (ref5 = (ref6 = (ref7 = resultObject.error) != null ? typeof ref7.toJSON === "function" ? ref7.toJSON() : void 0 : void 0) != null ? ref6 : resultObject != null ? resultObject.error : void 0) != null ? ref5 : null
      }
    });
    opts = {
      "new": true
    };
    return Model.findOneAndUpdate(query, kwargs, opts, function(err, updatedObject) {
      if (err != null) {
        return done(err);
      }
      if (updatedObject == null) {
        return done(new Error("Task no longer owned by caller."));
      }
      return done(null, updatedObject);
    });
  };
  schema.statics._dequeueOne = function(done) {
    var kwargs, opts, query, updateKwargs;
    query = {
      status: 'QUEUED'
    };
    updateKwargs = {};
    if (timeout) {
      updateKwargs.timeout_at = new Date(Date.now() + timeout);
    }
    kwargs = this._updateStatusKwargs('EXECUTING', null, {
      updateKwargs: updateKwargs
    });
    opts = {
      "new": true
    };
    return this.findOneAndUpdate(query, kwargs, opts, done);
  };
  return schema.statics._failTimedOutOne = function(done) {
    var kwargs, opts, query;
    query = {
      status: 'EXECUTING',
      timeout_at: {
        $lt: new Date()
      }
    };
    kwargs = this._updateStatusKwargs('FAILED', 'FAILED_TIMEOUT');
    opts = {
      "new": true
    };
    return this.findOneAndUpdate(query, kwargs, opts, done);
  };
};

module.exports = PluginFn;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3BsdWdpbi5qcyIsInNvdXJjZXMiOlsibGliL3BsdWdpbi5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsSUFBQTs7QUFBQSxDQUFBLEdBQWEsT0FBQSxDQUFRLFFBQVI7O0FBRWIsUUFBQSxHQUFhLE9BQUEsQ0FBUSxVQUFSOztBQUNiLE1BQUEsR0FBYSxRQUFRLENBQUM7O0FBS3RCLFNBQUEsR0FBWSxJQUFJLE1BQUosQ0FBVztFQUNyQixTQUFBLEVBQ0U7SUFBQSxRQUFBLEVBQVUsSUFBVjtJQUNBLElBQUEsRUFBVSxJQURWO0dBRm1CO0VBSXJCLEdBQUEsRUFDRTtJQUFBLFFBQUEsRUFBVSxJQUFWO0lBQ0EsSUFBQSxFQUFVLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FEdkI7R0FMbUI7Q0FBWDs7QUFVWixRQUFBLEdBQVcsU0FBQyxNQUFELEVBQVMsR0FBVDtBQUNULE1BQUE7c0JBRGtCLE1BQTZCLElBQTNCLHFCQUFRLGdEQUFVO0VBQ3RDLElBQW9HLGNBQXBHO0FBQUEsVUFBTSxJQUFJLEtBQUosQ0FBVSwyRUFBVixFQUFOOztFQUVBLE1BQU0sQ0FBQyxPQUFPLENBQUMsbUJBQWYsR0FDRTtJQUFBLE1BQUEsRUFBUyxNQUFUO0lBQ0EsT0FBQSxFQUFTLE9BRFQ7O0VBR0YsTUFBTSxDQUFDLEdBQVAsQ0FDRTtJQUFBLE1BQUEsRUFDRTtNQUFBLFFBQUEsRUFBVSxJQUFWO01BQ0EsSUFBQSxFQUFVLE1BRFY7TUFFQSxDQUFBLElBQUEsQ0FBQSxFQUFVLENBQUUsUUFBRixFQUFZLFdBQVosRUFBeUIsUUFBekIsRUFBbUMsU0FBbkMsQ0FGVjtLQURGO0lBSUEsU0FBQSxFQUNFO01BQUEsUUFBQSxFQUFVLEtBQVY7TUFDQSxDQUFBLE9BQUEsQ0FBQSxFQUFVLElBRFY7TUFFQSxJQUFBLEVBQVUsTUFGVjtNQUdBLENBQUEsSUFBQSxDQUFBLEVBQVUsQ0FBRSxZQUFGLEVBQWdCLGdCQUFoQixFQUFrQyxJQUFsQyxDQUhWO0tBTEY7SUFTQSxL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QXlCLE1BQXpCLEVBQWlDLElBQWpDLEVBQXVDLElBQXZDO0VBUGdDO0FBakl6Qjs7QUEySVgsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgICAgID0gcmVxdWlyZSAnbG9kYXNoJ1xuXG5tb25nb29zZSAgID0gcmVxdWlyZSAnbW9uZ29vc2UnXG5TY2hlbWEgICAgID0gbW9uZ29vc2UuU2NoZW1hXG5cbiMgU2NoZW1hc1xuIyBAVE9ETzogUG9sbGluZ1xuXG5Mb2dTY2hlbWEgPSBuZXcgU2NoZW1hIHtcbiAgdGltZXN0YW1wOlxuICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgdHlwZTogICAgIERhdGVcbiAgbG9nOlxuICAgIHJlcXVpcmVkOiB0cnVlXG4gICAgdHlwZTogICAgIFNjaGVtYS5UeXBlcy5NaXhlZFxufVxuXG4jIFBsdWdpblxuUGx1Z2luRm4gPSAoc2NoZW1hLCB7IHRhc2tGbiwgdGltZW91dCA9IG51bGwgfSA9IHt9KSAtPlxuICB0aHJvdyBuZXcgRXJyb3IoXCIndGFza0ZuJyBwYXJhbWV0ZXIgbXVzdCBiZSBwcm92aWRlZCB0byBNb25nb1F1ZXVlci5UYXNrUGx1Z2luIGNvbnN0cnVjdG9yXCIpIHVubGVzcyB0YXNrRm4/XG5cbiAgc2NoZW1hLnN0YXRpY3MuX21vbmdvUXVldWVyT3B0aW9ucyA9XG4gICAgdGFza0ZuOiAgdGFza0ZuXG4gICAgdGltZW91dDogdGltZW91dFxuXG4gIHNjaGVtYS5hZGRcbiAgICBzdGF0dXM6XG4gICAgICByZXF1aXJlZDogdHJ1ZVxuICAgICAgdHlwZTogICAgIFN0cmluZ1xuICAgICAgZW51bTogICAgIFsgJ1FVRVVFRCcsICdFWEVDVVRJTkcnLCAnRkFJTEVEJywgJ1NVQ0NFU1MnIF1cbiAgICBzdWJzdGF0dXM6XG4gICAgICByZXF1aXJlZDogZmFsc2VcbiAgICAgIGRlZmF1bHQ6ICBudWxsXG4gICAgICB0eXBlOiAgICAgU3RyaW5nXG4gICAgICBlbnVtOiAgICAgWyAnRkFJTEVEX0VSUicsICdGQUlMRURfVElNRU9VVCcsIG51bGwgXVxuICAgIGVycm9yOlxuICAgICAgcmVxdWlyZWQ6IGZhbHNlXG4gICAgICBkZWZhdWx0OiAgbnVsbFxuICAgICAgdHlwZTogICAgIFNjaGVtYS5UeXBlcy5NaXhlZFxuICAgIHJlc3VsdDpcbiAgICAgIHJlcXVpcmVkOiBmYWxzZVxuICAgICAgZGVmYXVsdDogIG51bGxcbiAgICAgIHR5cGU6ICAgICBTY2hlbWEuVHlwZXMuTWl4ZWRcbiAgICBzdGF0dXNfY2hhbmdlX2F0OlxuICAgICAgcmVxdWlyZWQ6IHRydWVcbiAgICAgIHR5cGU6ICAgICBEYXRlXG4gICAgdGltZW91dF9hdDpcbiAgICAgIHJlcXVpcmVkOiBmYWxzZVxuICAgICAgZGVmYXVsdDogIG51bGxcbiAgICAgIHR5cGU6ICAgICBEYXRlXG4gICAgc3RhdHVzX2hpc3Rvcnk6XG4gICAgICBkZWZhdWx0OiAgW11cbiAgICAgIHR5cGU6ICAgICBbIFNjaGVtYS5UeXBlcy5NaXhlZCBdXG4gICAgbG9nczpcbiAgICAgIGRlZmF1bHQ6ICBbXVxuICAgICAgdHlwZTogICAgIFsgTG9nU2NoZW1hIF1cblxuICAjIEhlbHBlcnNcbiAgc2NoZW1hLnN0YXRpY3MuX3VwZGF0ZVN0YXR1c0t3YXJncyA9IChzdGF0dXMsIHN1YnN0YXR1cywgeyB1cGRhdGVLd2FyZ3M9e30sIGlzSW5zZXJ0PWZhbHNlIH0gPSB7fSkgLT5cbiAgICBjb21tb25Ld2FyZ3MgPSBfLmFzc2lnbiB7XG4gICAgICBzdGF0dXM6ICAgICAgICAgICBzdGF0dXNcbiAgICAgIHN1YnN0YXR1czogICAgICAgIHN1YnN0YXR1c1xuICAgICAgc3RhdHVzX2NoYW5nZV9hdDogbmV3IERhdGUoKVxuICAgIH0sIHVwZGF0ZUt3YXJnc1xuXG4gICAga3dhcmdzID0gXy5jbG9uZSBjb21tb25Ld2FyZ3NcblxuICAgIGlmIGlzSW5zZXJ0XG4gICAgICBrd2FyZ3NbJ3N0YXR1c19oaXN0b3J5J10gPSBjb21tb25Ld2FyZ3NcbiAgICBlbHNlXG4gICAgICBrd2FyZ3NbJyRwdXNoJ10gPSB7IHN0YXR1c19oaXN0b3J5OiBjb21tb25Ld2FyZ3MgfVxuXG4gICAgcmV0dXJuIGt3YXJnc1xuXG4gICMgQ3JlYXRlXG4gIHNjaGVtYS5zdGF0aWNzLmNyZWF0ZVRhc2sgPSAodGFza0t3YXJncywgZG9uZSkgLT5cbiAgICBkZWZhdWx0S3dhcmdzID0gQF91cGRhdGVTdGF0dXNLd2FyZ3MgJ1FVRVVFRCcsIG51bGwsIGlzSW5zZXJ0OiB0cnVlXG5cbiAgICBrd2FyZ3MgPVxuICAgICAgXy5jaGFpbiB0YXNrS3dhcmdzXG4gICAgICAgIC5vbWl0IChrKSAtPiBrIGluIFtcInN0YXR1c1wiLCBcInN1YnN0YXR1c1wiLCBcImVycm9yXCIsIFwicmVzdWx0XCIsIFwic3RhdHVzX2NoYW5nZV9hdFwiLCBcInRpbWVvdXRfYXRcIiwgXCJzdGF0dXNfaGlzdG9yeVwiLCBcImxvZ3NcIl1cbiAgICAgICAgLmRlZmF1bHRzIGRlZmF1bHRLd2FyZ3NcbiAgICAgICAgLnZhbHVlKClcblxuICAgIHRhc2sgPSBuZXcgQChrd2FyZ3MpXG4gICAgdGFzay5zYXZlIChlcnIsIHRhc2ssIG51bUFmZmVjdGVkKSAtPlxuICAgICAgZG9uZSBlcnIsIHRhc2tcblxuICAjIExvZ2dpbmdcbiAgc2NoZW1hLm1ldGhvZHMuYWRkTG9nID0gKGxvZ0t3YXJncykgLT5cbiAgICBNb2RlbCA9IEBjb25zdHJ1Y3RvclxuXG4gICAgcXVlcnkgICAgICAgID0geyBfaWQ6IEBfaWQgfVxuICAgIG9wdHMgICAgICAgICA9IHsgdXBzZXJ0OiB0cnVlIH1cblxuICAgIHN1YkRvY0t3YXJncyA9XG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKClcbiAgICAgIGxvZzogICAgICAgbG9nS3dhcmdzXG5cbiAgICBrd2FyZ3MgICAgICAgPSB7ICRwdXNoOiB7IGxvZ3M6IHN1YkRvY0t3YXJncyB9IH1cblxuICAgICMgTG9nIGlzIG5vdCBjb25zaWRlcmVkIHRvIGJlIG1pc3Npb24tY3JpdGljYWwsIG5vIGNhbGxiYWNrLlxuICAgIE1vZGVsLnVwZGF0ZShxdWVyeSwga3dhcmdzLCBvcHRzKS5leGVjKClcblxuICBzY2hlbWEubWV0aG9kcy5yZXRyeSA9IChkb25lKSAtPlxuICAgIE1vZGVsID0gQGNvbnN0cnVjdG9yXG5cbiAgICB1bmxlc3MgQHN0YXR1cyBpbiBbICdGQUlMRUQnLCAnU1VDQ0VTUycgXVxuICAgICAgcmV0dXJuIGRvbmUgbmV3IEVycm9yKFwiSW1wcm9wZXIgc3RhdHVzIGZvciByZXRyeTogPCN7QHN0YXR1c30+XCIpXG5cbiAgICBAX3VwZGF0ZVN0YXR1cyAnUVVFVUVEJywgbnVsbCwgbnVsbCwgZG9uZVxuXG4gICMgVXBkYXRlXG4gIHNjaGVtYS5tZXRob2RzLl91cGRhdGVTdGF0dXMgPSAoc3RhdHVzLCBzdWJzdGF0dXMsIHJlc3VsdE9iamVjdD17fSwgZG9uZSkgLT5cbiAgICBNb2RlbCA9IEBjb25zdHJ1Y3RvclxuXG4gICAgcXVlcnkgPSB7IF9pZDogQF9pZCwgc3RhdHVzX2NoYW5nZV9hdDogQHN0YXR1c19jaGFuZ2VfYXQgfVxuXG4gICAga3dhcmdzID0gTW9kZWwuX3VwZGF0ZVN0YXR1c0t3YXJncyBzdGF0dXMsIHN1YnN0YXR1cywge1xuICAgICAgdXBkYXRlS3dhcmdzOlxuICAgICAgICByZXN1bHQ6IHJlc3VsdE9iamVjdC5yZXN1bHQ/LnRvSlNPTj8oKSA/IHJlc3VsdE9iamVjdD8ucmVzdWx0ID8gbnVsbFxuICAgICAgICBlcnJvcjogIHJlc3VsdE9iamVjdC5lcnJvcj8udG9KU09OPygpID8gcmVzdWx0T2JqZWN0Py5lcnJvciA/IG51bGxcbiAgICB9XG5cbiAgICBvcHRzICA9IHsgbmV3OiB0cnVlIH1cblxuICAgIE1vZGVsLmZpbmRPbmVBbmRVcGRhdGUgcXVlcnksIGt3YXJncywgb3B0cywgKGVyciwgdXBkYXRlZE9iamVjdCkgLT5cbiAgICAgIHJldHVybiBkb25lIGVyciBpZiBlcnI/XG4gICAgICByZXR1cm4gZG9uZSBuZXcgRXJyb3IoXCJUYXNrIG5vIGxvbmdlciBvd25lZCBieSBjYWxsZXIuXCIpIHVubGVzcyB1cGRhdGVkT2JqZWN0P1xuXG4gICAgICBkb25lIG51bGwsIHVwZGF0ZWRPYmplY3RcblxuICAjIEZldGNoXG4gIHNjaGVtYS5zdGF0aWNzLl9kZXF1ZXVlT25lID0gKGRvbmUpIC0+XG4gICAgcXVlcnkgID0geyBzdGF0dXM6ICdRVUVVRUQnIH1cblxuICAgIHVwZGF0ZUt3YXJncyA9IHt9XG4gICAgaWYgdGltZW91dFxuICAgICAgdXBkYXRlS3dhcmdzLnRpbWVvdXRfYXQgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgdGltZW91dClcblxuICAgIGt3YXJncyA9IEBfdXBkYXRlU3RhdHVzS3dhcmdzICdFWEVDVVRJTkcnLCBudWxsLCB7IHVwZGF0ZUt3YXJnczogdXBkYXRlS3dhcmdzIH1cblxuICAgICMgQ2FuJ3QgdXNlIG11bHRpLCBiZWNhdXNlIGl0J3Mgbm90IGF0b21pYy5cbiAgICBvcHRzICAgPSB7IG5ldzogdHJ1ZSB9XG5cbiAgICBAZmluZE9uZUFuZFVwZGF0ZSBxdWVyeSwga3dhcmdzLCBvcHRzLCBkb25lXG5cbiAgc2NoZW1hLnN0YXRpY3MuX2ZhaWxUaW1lZE91dE9uZSA9IChkb25lKSAtPlxuICAgIHF1ZXJ5ICA9IHsgc3RhdHVzOiAnRVhFQ1VUSU5HJywgdGltZW91dF9hdDogeyAkbHQ6IG5ldyBEYXRlKCkgfSB9XG4gICAga3dhcmdzID0gQF91cGRhdGVTdGF0dXNLd2FyZ3MgJ0ZBSUxFRCcsICdGQUlMRURfVElNRU9VVCdcblxuICAgICMgQ2FuJ3QgdXNlIG11bHRpLCBiZWNhdXNlIGl0J3Mgbm90IGF0b21pYy5cbiAgICBvcHRzICAgPSB7IG5ldzogdHJ1ZSB9XG5cbiAgICBAZmluZE9uZUFuZFVwZGF0ZSBxdWVyeSwga3dhcmdzLCBvcHRzLCBkb25lXG5cblxubW9kdWxlLmV4cG9ydHMgPSBQbHVnaW5GblxuIl19
